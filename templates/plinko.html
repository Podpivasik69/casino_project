{% extends 'base.html' %}

{% block title %}Plinko | SKET CASINO{% endblock %}

{% block content %}
<style>
    .game-room {
        background: rgba(26, 26, 36, 0.9);
        border: 1px solid var(--gray-dark);
        border-radius: var(--border-radius-xl);
        padding: 50px;
        margin-bottom: 40px;
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(10px);
    }

    .game-room::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: var(--gradient);
    }

    .game-header {
        text-align: center;
        margin-bottom: 50px;
    }

    .game-header h2 {
        font-family: 'Orbitron', sans-serif;
        font-size: 48px;
        font-weight: 800;
        background: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 15px;
    }

    .game-header p {
        color: var(--gray-light);
        font-size: 18px;
        max-width: 600px;
        margin: 0 auto 25px;
    }

    .current-balance {
        display: inline-flex;
        align-items: center;
        gap: 15px;
        background: rgba(16, 185, 129, 0.1);
        padding: 15px 30px;
        border-radius: var(--border-radius-xl);
        border: 1px solid rgba(16, 185, 129, 0.3);
        font-size: 20px;
        font-weight: 600;
        color: var(--light);
    }

    .game-controls {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 40px;
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
    }

    .control-group {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--gray-dark);
        border-radius: var(--border-radius-lg);
        padding: 20px;
    }

    .control-label {
        display: block;
        margin-bottom: 12px;
        color: var(--gray-light);
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .control-input, .control-select {
        width: 100%;
        padding: 12px 16px;
        background: rgba(26, 26, 36, 0.9);
        border: 1px solid var(--gray-dark);
        border-radius: var(--border-radius);
        color: var(--light);
        font-size: 16px;
        font-weight: 600;
        font-family: 'Orbitron', sans-serif;
        transition: var(--transition);
    }

    .control-select option {
        background: rgba(26, 26, 36, 1);
        color: var(--light);
    }

    .control-input:focus, .control-select:focus {
        outline: none;
        border-color: var(--primary);
        background: rgba(16, 185, 129, 0.05);
    }

    .risk-buttons {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
    }

    .risk-btn {
        padding: 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid var(--gray-dark);
        border-radius: var(--border-radius);
        color: var(--light);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        font-size: 14px;
    }

    .risk-btn:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .risk-btn.active {
        border-color: var(--primary);
        background: rgba(16, 185, 129, 0.2);
    }

    .risk-btn.low.active {
        border-color: #10b981;
        background: rgba(16, 185, 129, 0.2);
    }

    .risk-btn.medium.active {
        border-color: #f59e0b;
        background: rgba(245, 158, 11, 0.2);
    }

    .risk-btn.high.active {
        border-color: #ef4444;
        background: rgba(239, 68, 68, 0.2);
    }

    .plinko-board {
        max-width: 700px;
        margin: 40px auto;
        background: rgba(26, 26, 36, 0.8);
        border: 2px solid var(--gray-dark);
        border-radius: var(--border-radius-lg);
        padding: 30px 0px;
        position: relative;
        overflow: hidden;
    }

    .plinko-rows {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-bottom: 20px;
    }

    .plinko-row {
        display: flex;
        justify-content: center;
        gap: 30px;
    }

    .plinko-peg {
        width: 8px;
        height: 8px;
        background: var(--gray-light);
        border-radius: 50%;
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
    }

    .plinko-ball {
        width: 20px;
        height: 20px;
        background: var(--gradient);
        border-radius: 50%;
        position: absolute;
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.8);
        transition: all 0.3s ease;
        z-index: 10;
    }

    .plinko-buckets {
        display: flex;
        flex-wrap: nowrap;
        justify-content: center;
        gap: 3px;
        margin: 20px 20px 0 20px;
        padding: 0 10px;
        box-sizing: border-box;
    }
    
    /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –∫–æ—Ä–∑–∏–Ω –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ */
    .plinko-buckets[data-bucket-count="6"] .plinko-bucket {
        flex: 0 0 calc((100% - 15px) / 6);  /* 6 –∫–æ—Ä–∑–∏–Ω, 5 –ø—Ä–æ–º–µ–∂—É—Ç–∫–æ–≤ –ø–æ 3px */
        max-width: 90px;
    }
    
    .plinko-buckets[data-bucket-count="10"] .plinko-bucket {
        flex: 0 0 calc((100% - 27px) / 10);  /* 10 –∫–æ—Ä–∑–∏–Ω, 9 –ø—Ä–æ–º–µ–∂—É—Ç–∫–æ–≤ */
        max-width: 55px;
    }
    
    .plinko-buckets[data-bucket-count="12"] .plinko-bucket {
        flex: 0 0 calc((100% - 33px) / 12);  /* 12 –∫–æ—Ä–∑–∏–Ω, 11 –ø—Ä–æ–º–µ–∂—É—Ç–∫–æ–≤ */
        max-width: 48px;
    }
    
    .plinko-buckets[data-bucket-count="14"] .plinko-bucket {
        flex: 0 0 calc((100% - 39px) / 14);  /* 14 –∫–æ—Ä–∑–∏–Ω, 13 –ø—Ä–æ–º–µ–∂—É—Ç–∫–æ–≤ */
        max-width: 42px;
    }
    
    .plinko-buckets[data-bucket-count="16"] .plinko-bucket {
        flex: 0 0 calc((100% - 45px) / 16);  /* 16 –∫–æ—Ä–∑–∏–Ω, 15 –ø—Ä–æ–º–µ–∂—É—Ç–∫–æ–≤ */
        max-width: 38px;
    }

    .plinko-bucket {
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid var(--gray-dark);
        border-radius: var(--border-radius);
        text-align: center;
        font-weight: 700;
        color: var(--light);
        font-family: 'Orbitron', sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        box-sizing: border-box;
        word-break: break-word;
        overflow: hidden;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã —à—Ä–∏—Ñ—Ç–∞ –∏ –≤—ã—Å–æ—Ç—ã */
    .plinko-buckets[data-bucket-count="6"] .plinko-bucket {
        font-size: 16px;
        min-height: 50px;
        padding: 10px 4px;
    }
    
    .plinko-buckets[data-bucket-count="10"] .plinko-bucket {
        font-size: 13px;
        min-height: 45px;
        padding: 9px 3px;
    }
    
    .plinko-buckets[data-bucket-count="12"] .plinko-bucket {
        font-size: 12px;
        min-height: 42px;
        padding: 8px 2px;
    }
    
    .plinko-buckets[data-bucket-count="14"] .plinko-bucket {
        font-size: 11px;
        min-height: 40px;
        padding: 8px 2px;
    }
    
    .plinko-buckets[data-bucket-count="16"] .plinko-bucket {
        font-size: 10px;
        min-height: 38px;
        padding: 7px 1px;
    }

    .plinko-bucket.losing {
        border-color: rgba(239, 68, 68, 0.5);
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .plinko-bucket.winning {
        border-color: rgba(16, 185, 129, 0.5);
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }

    .plinko-bucket.active {
        background: rgba(16, 185, 129, 0.3);
        border-color: var(--primary);
        animation: bucketPulse 0.5s ease;
    }

    @keyframes bucketPulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    .game-info {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin: 40px 0;
        flex-wrap: wrap;
    }

    .info-box {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--gray-dark);
        border-radius: var(--border-radius-lg);
        padding: 20px 30px;
        text-align: center;
        min-width: 150px;
    }

    .info-label {
        color: var(--gray-light);
        font-size: 12px;
        text-transform: uppercase;
        margin-bottom: 10px;
    }

    .info-value {
        font-size: 28px;
        font-weight: 800;
        color: var(--light);
        font-family: 'Orbitron', sans-serif;
    }

    .info-value.multiplier {
        background: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .game-actions {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 40px 0;
        flex-wrap: wrap;
    }

    .auto-play-controls {
        display: none;
        max-width: 600px;
        margin: 20px auto;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--gray-dark);
        border-radius: var(--border-radius-lg);
    }

    .auto-play-controls.active {
        display: block;
    }

    .hidden {
        display: none !important;
    }

    @media (max-width: 768px) {
        .game-room {
            padding: 30px 20px;
        }
        .game-header h2 {
            font-size: 36px;
        }
        .game-controls {
            grid-template-columns: 1fr;
        }
        .plinko-board {
            padding: 20px 0px;
            max-width: 100%;
        }
        .plinko-row {
            gap: 15px;
        }
        .plinko-buckets {
            margin: 20px 10px 0 10px;
            padding: 0 5px;
            gap: 2px;
        }
        
        /* –ú–æ–±–∏–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∫–æ—Ä–∑–∏–Ω */
        .plinko-buckets[data-bucket-count="6"] .plinko-bucket {
            flex: 0 0 calc((100% - 10px) / 6);
            max-width: 70px;
            font-size: 14px;
            min-height: 42px;
            padding: 8px 3px;
        }
        .plinko-buckets[data-bucket-count="10"] .plinko-bucket {
            flex: 0 0 calc((100% - 18px) / 10);
            max-width: 45px;
            font-size: 11px;
            min-height: 38px;
            padding: 7px 2px;
        }
        .plinko-buckets[data-bucket-count="12"] .plinko-bucket {
            flex: 0 0 calc((100% - 22px) / 12);
            max-width: 38px;
            font-size: 10px;
            min-height: 36px;
            padding: 6px 1px;
        }
        .plinko-buckets[data-bucket-count="14"] .plinko-bucket {
            flex: 0 0 calc((100% - 26px) / 14);
            max-width: 32px;
            font-size: 9px;
            min-height: 34px;
            padding: 6px 1px;
        }
        .plinko-buckets[data-bucket-count="16"] .plinko-bucket {
            flex: 0 0 calc((100% - 30px) / 16);
            max-width: 28px;
            font-size: 8px;
            min-height: 32px;
            padding: 5px 1px;
        }
    }
</style>

<div class="game-room">
    <div class="game-header">
        <h2>üéØ PLINKO</h2>
        <p>–ë—Ä–æ—Å—å—Ç–µ —à–∞—Ä–∏–∫ –∏ –Ω–∞–±–ª—é–¥–∞–π—Ç–µ, –∫–∞–∫ –æ–Ω –ø–∞–¥–∞–µ—Ç —á–µ—Ä–µ–∑ –∫–æ–ª—ã—à–∫–∏. –í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –º–Ω–æ–∂–∏—Ç–µ–ª–µ–π!</p>
        <div class="current-balance">
            <i class="fas fa-wallet"></i>
            –ë–∞–ª–∞–Ω—Å: <span id="game-balance">{{ user.profile.balance|floatformat:"-2" }}</span> ‚ÇΩ
        </div>
    </div>

    <!-- Game Controls -->
    <div class="game-controls" id="gameControls">
        <div class="control-group">
            <label class="control-label">–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏ (‚ÇΩ)</label>
            <input type="number" id="betAmount" class="control-input" value="100" min="10" step="10">
        </div>
        <div class="control-group">
            <label class="control-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä—è–¥–æ–≤</label>
            <select id="rowCount" class="control-select">
                <option value="5">5 —Ä—è–¥–æ–≤</option>
                <option value="9">9 —Ä—è–¥–æ–≤</option>
                <option value="11" selected>11 —Ä—è–¥–æ–≤</option>
                <option value="13">13 —Ä—è–¥–æ–≤</option>
                <option value="15">15 —Ä—è–¥–æ–≤</option>
            </select>
        </div>
        <div class="control-group">
            <label class="control-label">–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞</label>
            <div class="risk-buttons">
                <button class="risk-btn low" onclick="selectRisk('low')">–ù–∏–∑–∫–∏–π</button>
                <button class="risk-btn medium active" onclick="selectRisk('medium')">–°—Ä–µ–¥–Ω–∏–π</button>
                <button class="risk-btn high" onclick="selectRisk('high')">–í—ã—Å–æ–∫–∏–π</button>
            </div>
        </div>
    </div>

    <!-- Game Info -->
    <div class="game-info">
        <div class="info-box">
            <div class="info-label">–ü–æ—Å–ª–µ–¥–Ω–∏–π –º–Ω–æ–∂–∏—Ç–µ–ª—å</div>
            <div class="info-value multiplier" id="lastMultiplier">-</div>
        </div>
        <div class="info-box">
            <div class="info-label">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–∏–≥—Ä—ã—à</div>
            <div class="info-value" id="lastWinnings">0.00 ‚ÇΩ</div>
        </div>
    </div>

    <!-- Plinko Board -->
    <div class="plinko-board" id="plinkoBoard">
        <div class="plinko-rows" id="plinkoRows">
            <!-- Rows will be generated by JavaScript -->
        </div>
        <div class="plinko-buckets" id="plinkoBuckets">
            <!-- Buckets will be generated by JavaScript -->
        </div>
    </div>

    <!-- Game Actions -->
    <div class="game-actions">
        <button class="btn btn-primary btn-lg" id="dropBtn" onclick="dropBall()">
            <i class="fas fa-play"></i> –ë–†–û–°–ò–¢–¨ –®–ê–†–ò–ö
        </button>
        <button class="btn btn-secondary" id="autoPlayBtn" onclick="toggleAutoPlay()">
            <i class="fas fa-sync"></i> –ê–í–¢–û–ò–ì–†–ê
        </button>
        <a href="/profile/" class="btn btn-secondary">
            <i class="fas fa-user"></i> –ü–†–û–§–ò–õ–¨
        </a>
    </div>

    <!-- Auto Play Controls -->
    <div class="auto-play-controls" id="autoPlayControls">
        <div style="display: flex; gap: 20px; align-items: center; justify-content: center;">
            <div>
                <label class="control-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—Ä–æ—Å–∫–æ–≤</label>
                <input type="number" id="autoDropCount" class="control-input" value="10" min="1" max="100" style="width: 150px;">
            </div>
            <button class="btn btn-primary" onclick="startAutoPlay()">
                <i class="fas fa-play"></i> –ó–ê–ü–£–°–¢–ò–¢–¨
            </button>
            <button class="btn btn-danger" onclick="stopAutoPlay()">
                <i class="fas fa-stop"></i> –û–°–¢–ê–ù–û–í–ò–¢–¨
            </button>
        </div>
        <div id="autoPlayStatus" style="text-align: center; margin-top: 15px; color: var(--gray-light);"></div>
    </div>
</div>

<script>
    let currentRisk = 'medium';
    let isDropping = false;
    let autoPlayActive = false;
    let autoPlayInterval = null;
    let multipliers = {};

    // Load multipliers
    async function loadMultipliers() {
        try {
            const response = await fetch('/api/games/plinko/multipliers/');
            const data = await response.json();
            if (data.success) {
                multipliers = data.multipliers;
                updateBoard();
            }
        } catch (error) {
            console.error('Error loading multipliers:', error);
        }
    }

    // Select risk level
    function selectRisk(risk) {
        currentRisk = risk;
        document.querySelectorAll('.risk-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.risk-btn.${risk}`).classList.add('active');
        updateBoard();
    }

    // Update board (rows and buckets)
    function updateBoard() {
        const rowCount = parseInt(document.getElementById('rowCount').value);
        const rowsContainer = document.getElementById('plinkoRows');
        const bucketsContainer = document.getElementById('plinkoBuckets');
        
        // Generate rows
        rowsContainer.innerHTML = '';
        for (let i = 0; i <= rowCount; i++) {
            const row = document.createElement('div');
            row.className = 'plinko-row';
            for (let j = 0; j <= i; j++) {
                const peg = document.createElement('div');
                peg.className = 'plinko-peg';
                row.appendChild(peg);
            }
            rowsContainer.appendChild(row);
        }
        
        // Generate buckets with multipliers
        bucketsContainer.innerHTML = '';
        if (multipliers[currentRisk] && multipliers[currentRisk][rowCount]) {
            const mults = multipliers[currentRisk][rowCount];
            
            // Set bucket count for CSS styling
            bucketsContainer.setAttribute('data-bucket-count', mults.length);
            
            mults.forEach((mult, index) => {
                const bucket = document.createElement('div');
                bucket.className = 'plinko-bucket';
                bucket.dataset.index = index;
                bucket.textContent = mult + 'x';
                
                // Add color class based on multiplier
                if (mult < 1.0) {
                    bucket.classList.add('losing');
                } else if (mult > 1.0) {
                    bucket.classList.add('winning');
                }
                
                bucketsContainer.appendChild(bucket);
            });
        }
    }

    // Drop ball
    async function dropBall() {
        if (isDropping) return;
        
        const betAmount = parseFloat(document.getElementById('betAmount').value);
        const rowCount = parseInt(document.getElementById('rowCount').value);
        
        // Validation
        if (betAmount < 10) {
            showMessage('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ 10 ‚ÇΩ', 'error');
            return;
        }
        
        isDropping = true;
        document.getElementById('dropBtn').disabled = true;
        
        try {
            // Create game
            const createResponse = await fetch('/api/games/plinko/create/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    bet_amount: betAmount,
                    row_count: rowCount,
                    risk_level: currentRisk
                })
            });
            
            const createData = await createResponse.json();
            
            if (!createResponse.ok) {
                showMessage(createData.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã', 'error');
                isDropping = false;
                document.getElementById('dropBtn').disabled = false;
                return;
            }
            
            const gameId = createData.game.id;
            
            // Drop ball
            const dropResponse = await fetch(`/api/games/plinko/${gameId}/drop/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const dropData = await dropResponse.json();
            
            if (dropResponse.ok) {
                // Animate ball
                await animateBall(dropData.result.ball_path, dropData.result.bucket_index);
                
                // Update UI
                const multiplier = parseFloat(dropData.result.multiplier);
                const winnings = parseFloat(dropData.result.winnings);
                const betAmount = parseFloat(document.getElementById('betAmount').value);
                
                document.getElementById('lastMultiplier').textContent = multiplier.toFixed(2) + 'x';
                document.getElementById('lastWinnings').textContent = formatCurrency(winnings) + ' ‚ÇΩ';
                document.getElementById('game-balance').textContent = formatCurrency(dropData.balance);
                
                // Show win/loss message
                if (multiplier < 1.0) {
                    const loss = betAmount - winnings;
                    showMessage(`–ü—Ä–æ–∏–≥—Ä—ã—à: -${formatCurrency(loss)} ‚ÇΩ (${multiplier.toFixed(2)}x)`, 'error');
                } else if (multiplier === 1.0) {
                    showMessage(`–í–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞–≤–∫–∏ (${multiplier.toFixed(2)}x)`, 'info');
                } else {
                    const profit = winnings - betAmount;
                    showMessage(`–í—ã–∏–≥—Ä—ã—à: +${formatCurrency(profit)} ‚ÇΩ (${multiplier.toFixed(2)}x)`, 'success');
                }
            } else {
                showMessage(dropData.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –±—Ä–æ—Å–∫–µ', 'error');
            }
        } catch (error) {
            console.error('Drop ball error:', error);
            showMessage('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
        } finally {
            isDropping = false;
            document.getElementById('dropBtn').disabled = false;
        }
    }

    // Animate ball falling
    async function animateBall(path, finalBucket) {
        const board = document.getElementById('plinkoBoard');
        const rowsContainer = document.getElementById('plinkoRows');
        const bucketsContainer = document.getElementById('plinkoBuckets');
        
        const ball = document.createElement('div');
        ball.className = 'plinko-ball';
        board.appendChild(ball);
        
        // Calculate board dimensions
        const boardRect = board.getBoundingClientRect();
        const rowsRect = rowsContainer.getBoundingClientRect();
        const bucketsRect = bucketsContainer.getBoundingClientRect();
        
        // Start position (top center of rows)
        let x = boardRect.width / 2;
        let y = rowsRect.top - boardRect.top + 10;
        ball.style.left = x + 'px';
        ball.style.top = y + 'px';
        
        // Calculate step sizes based on actual row spacing
        const rowCount = path.length;
        const totalHeight = bucketsRect.top - rowsRect.top - 40;
        const verticalStep = totalHeight / rowCount;
        const horizontalStep = 30;
        
        // Animate through path
        const stepDelay = 200;
        
        for (let i = 0; i < path.length; i++) {
            await new Promise(resolve => setTimeout(resolve, stepDelay));
            
            // Move left (0) or right (1)
            if (path[i] === 0) {
                x -= horizontalStep / 2;
            } else {
                x += horizontalStep / 2;
            }
            y += verticalStep;
            
            ball.style.left = x + 'px';
            ball.style.top = y + 'px';
        }
        
        // Move to final bucket position
        await new Promise(resolve => setTimeout(resolve, stepDelay));
        const buckets = document.querySelectorAll('.plinko-bucket');
        if (buckets[finalBucket]) {
            const bucketRect = buckets[finalBucket].getBoundingClientRect();
            const bucketX = bucketRect.left - boardRect.left + bucketRect.width / 2;
            const bucketY = bucketRect.top - boardRect.top + bucketRect.height / 2;
            
            ball.style.left = bucketX + 'px';
            ball.style.top = bucketY + 'px';
            
            // Highlight final bucket
            buckets.forEach(b => b.classList.remove('active'));
            buckets[finalBucket].classList.add('active');
        }
        
        // Remove ball
        await new Promise(resolve => setTimeout(resolve, 800));
        ball.remove();
    }

    // Toggle auto play
    function toggleAutoPlay() {
        autoPlayActive = !autoPlayActive;
        const controls = document.getElementById('autoPlayControls');
        controls.classList.toggle('active');
    }

    // Start auto play
    async function startAutoPlay() {
        const dropCount = parseInt(document.getElementById('autoDropCount').value);
        
        if (dropCount < 1 || dropCount > 100) {
            showMessage('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—Ä–æ—Å–∫–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ 100', 'error');
            return;
        }
        
        const betAmount = parseFloat(document.getElementById('betAmount').value);
        const rowCount = parseInt(document.getElementById('rowCount').value);
        
        if (betAmount < 10) {
            showMessage('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ 10 ‚ÇΩ', 'error');
            return;
        }
        
        document.getElementById('dropBtn').disabled = true;
        document.getElementById('autoPlayBtn').disabled = true;
        
        try {
            const response = await fetch('/api/games/plinko/auto/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    bet_amount: betAmount,
                    row_count: rowCount,
                    risk_level: currentRisk,
                    drop_count: dropCount
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Update UI
                document.getElementById('game-balance').textContent = formatCurrency(data.balance);
                document.getElementById('autoPlayStatus').textContent = 
                    `–í—ã–ø–æ–ª–Ω–µ–Ω–æ ${data.total_drops} –±—Ä–æ—Å–∫–æ–≤. –û–±—â–∏–π –≤—ã–∏–≥—Ä—ã—à: ${formatCurrency(data.total_winnings)} ‚ÇΩ`;
                
                showMessage(`–ê–≤—Ç–æ–∏–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –í—ã–∏–≥—Ä—ã—à: ${formatCurrency(data.total_winnings)} ‚ÇΩ`, 'success');
            } else {
                showMessage(data.error || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–∏–≥—Ä—ã', 'error');
            }
        } catch (error) {
            console.error('Auto play error:', error);
            showMessage('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
        } finally {
            document.getElementById('dropBtn').disabled = false;
            document.getElementById('autoPlayBtn').disabled = false;
        }
    }

    // Stop auto play
    function stopAutoPlay() {
        if (autoPlayInterval) {
            clearInterval(autoPlayInterval);
            autoPlayInterval = null;
        }
        document.getElementById('autoPlayStatus').textContent = '–ê–≤—Ç–æ–∏–≥—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞';
    }

    // Initialize on page load
    document.getElementById('rowCount').addEventListener('change', updateBoard);
    loadMultipliers();
</script>
{% endblock %}
