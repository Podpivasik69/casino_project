{% extends 'base.html' %}

{% block title %}Mines | SKET CASINO{% endblock %}

{% block content %}
<style>
    .game-room {
        background: rgba(26, 26, 36, 0.9);
        border: 1px solid var(--gray-dark);
        border-radius: var(--border-radius-xl);
        padding: 50px;
        margin-bottom: 40px;
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(10px);
    }

    .game-room::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: var(--gradient);
    }

    .game-header {
        text-align: center;
        margin-bottom: 50px;
    }

    .game-header h2 {
        font-family: 'Orbitron', sans-serif;
        font-size: 48px;
        font-weight: 800;
        background: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 15px;
    }

    .game-header p {
        color: var(--gray-light);
        font-size: 18px;
        max-width: 600px;
        margin: 0 auto 25px;
    }

    .current-balance {
        display: inline-flex;
        align-items: center;
        gap: 15px;
        background: rgba(16, 185, 129, 0.1);
        padding: 15px 30px;
        border-radius: var(--border-radius-xl);
        border: 1px solid rgba(16, 185, 129, 0.3);
        font-size: 20px;
        font-weight: 600;
        color: var(--light);
    }

    .game-controls {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 40px;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }

    .control-group {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--gray-dark);
        border-radius: var(--border-radius-lg);
        padding: 25px;
    }

    .control-label {
        display: block;
        margin-bottom: 15px;
        color: var(--gray-light);
        font-weight: 600;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .control-input {
        width: 100%;
        padding: 15px 20px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--gray-dark);
        border-radius: var(--border-radius);
        color: var(--light);
        font-size: 18px;
        font-weight: 600;
        font-family: 'Orbitron', sans-serif;
        transition: var(--transition);
    }

    .control-input:focus {
        outline: none;
        border-color: var(--primary);
        background: rgba(16, 185, 129, 0.05);
    }

    .mines-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 12px;
        max-width: 500px;
        margin: 40px auto;
    }

    .mine-cell {
        aspect-ratio: 1;
        background: rgba(26, 26, 36, 0.8);
        border: 2px solid var(--gray-dark);
        border-radius: var(--border-radius);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        cursor: pointer;
        transition: var(--transition);
        position: relative;
    }

    .mine-cell:hover:not(.opened):not(.mine):not(.disabled) {
        background: rgba(16, 185, 129, 0.1);
        border-color: var(--primary);
        transform: scale(1.05);
    }

    .mine-cell.opened {
        background: rgba(16, 185, 129, 0.2);
        border-color: var(--success);
        animation: cellReveal 0.3s ease;
    }

    .mine-cell.mine {
        background: rgba(239, 68, 68, 0.2);
        border-color: var(--danger);
        animation: cellExplode 0.5s ease;
    }

    .mine-cell.disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }

    @keyframes cellReveal {
        0% { transform: scale(0.8); opacity: 0; }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); opacity: 1; }
    }

    @keyframes cellExplode {
        0% { transform: scale(1); }
        25% { transform: scale(1.2); }
        50% { transform: scale(0.9); }
        75% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    .game-info {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin: 40px 0;
        flex-wrap: wrap;
    }

    .info-box {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--gray-dark);
        border-radius: var(--border-radius-lg);
        padding: 20px 30px;
        text-align: center;
        min-width: 150px;
    }

    .info-label {
        color: var(--gray-light);
        font-size: 12px;
        text-transform: uppercase;
        margin-bottom: 10px;
    }

    .info-value {
        font-size: 28px;
        font-weight: 800;
        color: var(--light);
        font-family: 'Orbitron', sans-serif;
    }

    .info-value.multiplier {
        background: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .game-actions {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 40px 0;
        flex-wrap: wrap;
    }

    .hidden {
        display: none !important;
    }

    @media (max-width: 768px) {
        .game-room {
            padding: 30px 20px;
        }
        .game-header h2 {
            font-size: 36px;
        }
        .game-controls {
            grid-template-columns: 1fr;
        }
        .mines-grid {
            max-width: 350px;
            gap: 8px;
        }
        .mine-cell {
            font-size: 24px;
        }
    }
</style>

<div class="game-room">
    <div class="game-header">
        <h2>üí£ MINES</h2>
        <p>–ù–∞–π–¥–∏—Ç–µ –≤—Å–µ –∞–ª–º–∞–∑—ã, –∏–∑–±–µ–≥–∞—è –º–∏–Ω. –ö–∞–∂–¥–∞—è –æ—Ç–∫—Ä—ã—Ç–∞—è –∫–ª–µ—Ç–∫–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –º–Ω–æ–∂–∏—Ç–µ–ª—å!</p>
        <div class="current-balance">
            <i class="fas fa-wallet"></i>
            –ë–∞–ª–∞–Ω—Å: <span id="game-balance">{{ user.profile.balance|floatformat:"-2" }}</span> ‚ÇΩ
        </div>
    </div>

    <!-- Game Controls -->
    <div class="game-controls" id="gameControls">
        <div class="control-group">
            <label class="control-label">–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏ (‚ÇΩ)</label>
            <input type="number" id="betAmount" class="control-input" value="100" min="10" step="10">
        </div>
        <div class="control-group">
            <label class="control-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω (3-20)</label>
            <input type="number" id="mineCount" class="control-input" value="5" min="3" max="20">
        </div>
    </div>

    <!-- Game Info -->
    <div class="game-info">
        <div class="info-box">
            <div class="info-label">–û—Ç–∫—Ä—ã—Ç–æ –∫–ª–µ—Ç–æ–∫</div>
            <div class="info-value" id="openedCells">0</div>
        </div>
        <div class="info-box">
            <div class="info-label">–¢–µ–∫—É—â–∏–π –º–Ω–æ–∂–∏—Ç–µ–ª—å</div>
            <div class="info-value multiplier" id="currentMultiplier">1.00x</div>
        </div>
        <div class="info-box">
            <div class="info-label">–í–æ–∑–º–æ–∂–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à</div>
            <div class="info-value" id="potentialWin">0.00 ‚ÇΩ</div>
        </div>
    </div>

    <!-- Mines Grid -->
    <div class="mines-grid" id="minesGrid">
        <!-- Grid will be generated by JavaScript -->
    </div>

    <!-- Game Actions -->
    <div class="game-actions">
        <button class="btn btn-primary btn-lg" id="startBtn" onclick="startGame()">
            <i class="fas fa-play"></i> –ù–ê–ß–ê–¢–¨ –ò–ì–†–£
        </button>
        <button class="btn btn-primary btn-lg hidden" id="cashoutBtn" onclick="cashout()">
            <i class="fas fa-money-bill-wave"></i> –ó–ê–ë–†–ê–¢–¨ –í–´–ò–ì–†–´–®
        </button>
        <button class="btn btn-secondary hidden" id="newGameBtn" onclick="resetGame()">
            <i class="fas fa-redo"></i> –ù–û–í–ê–Ø –ò–ì–†–ê
        </button>
        <a href="/profile/" class="btn btn-secondary">
            <i class="fas fa-user"></i> –ü–†–û–§–ò–õ–¨
        </a>
    </div>
</div>

<script>
    let currentGameId = null;
    let gameState = 'idle'; // idle, playing, finished
    let openedCellsCount = 0;

    // Initialize grid
    function initGrid() {
        const grid = document.getElementById('minesGrid');
        grid.innerHTML = '';
        
        for (let i = 0; i < 25; i++) {
            const cell = document.createElement('div');
            cell.className = 'mine-cell disabled';
            cell.dataset.index = i;
            cell.innerHTML = '?';
            cell.onclick = () => openCell(i);
            grid.appendChild(cell);
        }
    }

    // Start new game
    async function startGame() {
        const betAmount = parseFloat(document.getElementById('betAmount').value);
        const mineCount = parseInt(document.getElementById('mineCount').value);
        
        console.log('Starting game:', { betAmount, mineCount });
        
        // Validation
        if (betAmount < 10) {
            showMessage('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ 10 ‚ÇΩ', 'error');
            return;
        }
        
        if (mineCount < 3 || mineCount > 20) {
            showMessage('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 3 –¥–æ 20', 'error');
            return;
        }
        
        try {
            const response = await fetch('/api/games/mines/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    bet_amount: betAmount,
                    mine_count: mineCount
                })
            });
            
            const data = await response.json();
            console.log('Create game response:', data);
            
            if (response.ok) {
                currentGameId = data.game_id;
                gameState = 'playing';
                openedCellsCount = 0;
                
                console.log('Game created successfully, ID:', currentGameId);
                
                // Update UI
                if (data.new_balance) {
                    updateBalance(data.new_balance);
                    document.getElementById('game-balance').textContent = formatCurrency(data.new_balance);
                }
                document.getElementById('openedCells').textContent = '0';
                document.getElementById('currentMultiplier').textContent = '1.00x';
                document.getElementById('potentialWin').textContent = formatCurrency(betAmount) + ' ‚ÇΩ';
                
                // Enable grid
                document.querySelectorAll('.mine-cell').forEach(cell => {
                    cell.className = 'mine-cell';
                    cell.innerHTML = '?';
                });
                
                // Update buttons
                document.getElementById('startBtn').classList.add('hidden');
                document.getElementById('cashoutBtn').classList.remove('hidden');
                document.getElementById('gameControls').style.opacity = '0.5';
                document.getElementById('gameControls').style.pointerEvents = 'none';
                
                showMessage('–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –û—Ç–∫—Ä—ã–≤–∞–π—Ç–µ –∫–ª–µ—Ç–∫–∏', 'success');
            } else {
                console.error('Create game failed:', data);
                showMessage(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã', 'error');
            }
        } catch (error) {
            console.error('Start game error:', error);
            showMessage('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
        }
    }

    // Open cell
    async function openCell(cellIndex) {
        if (gameState !== 'playing') return;
        
        const cell = document.querySelector(`[data-index="${cellIndex}"]`);
        if (cell.classList.contains('opened') || cell.classList.contains('mine')) return;
        
        console.log('Opening cell:', cellIndex, 'Game ID:', currentGameId);
        
        try {
            const response = await fetch(`/api/games/mines/${currentGameId}/open/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ cell_index: cellIndex })
            });
            
            const data = await response.json();
            console.log('Open cell response:', data);
            
            if (response.ok) {
                if (data.hit_mine) {
                    // Hit mine - game over
                    cell.classList.add('mine');
                    cell.innerHTML = 'üí£';
                    gameState = 'finished';
                    
                    // Reveal all mines
                    data.mine_positions.forEach(pos => {
                        const mineCell = document.querySelector(`[data-index="${pos}"]`);
                        if (mineCell && !mineCell.classList.contains('mine')) {
                            mineCell.classList.add('mine');
                            mineCell.innerHTML = 'üí£';
                        }
                    });
                    
                    // Disable all cells
                    document.querySelectorAll('.mine-cell').forEach(c => c.classList.add('disabled'));
                    
                    // Update buttons
                    document.getElementById('cashoutBtn').classList.add('hidden');
                    document.getElementById('newGameBtn').classList.remove('hidden');
                    
                    showMessage('–í—ã –ø–æ–ø–∞–ª–∏ –Ω–∞ –º–∏–Ω—É! –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞', 'error');
                } else {
                    // Safe cell
                    cell.classList.add('opened');
                    cell.innerHTML = 'üíé';
                    openedCellsCount++;
                    
                    // Update info
                    document.getElementById('openedCells').textContent = openedCellsCount;
                    document.getElementById('currentMultiplier').textContent = data.current_multiplier.toFixed(2) + 'x';
                    
                    const betAmount = parseFloat(document.getElementById('betAmount').value);
                    const potentialWin = betAmount * data.current_multiplier;
                    document.getElementById('potentialWin').textContent = formatCurrency(potentialWin) + ' ‚ÇΩ';
                    
                    showMessage(`–ë–µ–∑–æ–ø–∞—Å–Ω–æ! –ú–Ω–æ–∂–∏—Ç–µ–ª—å: ${data.current_multiplier.toFixed(2)}x`, 'success');
                }
            } else {
                console.error('Open cell failed:', data);
                showMessage(data.error || '–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–ª–µ—Ç–∫–∏', 'error');
            }
        } catch (error) {
            console.error('Open cell error:', error);
            showMessage('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
        }
    }

    // Cashout
    async function cashout() {
        if (gameState !== 'playing') return;
        
        if (openedCellsCount === 0) {
            showMessage('–û—Ç–∫—Ä–æ–π—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–ª–µ—Ç–∫—É –ø–µ—Ä–µ–¥ –≤—ã–≤–æ–¥–æ–º', 'error');
            return;
        }
        
        console.log('Cashing out game:', currentGameId);
        
        try {
            const response = await fetch(`/api/games/mines/${currentGameId}/cashout/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            console.log('Cashout response:', data);
            
            if (response.ok) {
                gameState = 'finished';
                
                // Update balance
                if (data.new_balance) {
                    updateBalance(data.new_balance);
                    document.getElementById('game-balance').textContent = formatCurrency(data.new_balance);
                }
                
                // Disable all cells
                document.querySelectorAll('.mine-cell').forEach(c => c.classList.add('disabled'));
                
                // Update buttons
                document.getElementById('cashoutBtn').classList.add('hidden');
                document.getElementById('newGameBtn').classList.remove('hidden');
                
                const winnings = parseFloat(data.winnings);
                showMessage(`–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ ${formatCurrency(winnings)} ‚ÇΩ`, 'success');
            } else {
                console.error('Cashout failed:', data);
                showMessage(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≤–æ–¥–µ', 'error');
            }
        } catch (error) {
            console.error('Cashout error:', error);
            showMessage('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
        }
    }

    // Reset game
    function resetGame() {
        currentGameId = null;
        gameState = 'idle';
        openedCellsCount = 0;
        
        // Reset grid
        initGrid();
        
        // Reset info
        document.getElementById('openedCells').textContent = '0';
        document.getElementById('currentMultiplier').textContent = '1.00x';
        document.getElementById('potentialWin').textContent = '0.00 ‚ÇΩ';
        
        // Reset buttons
        document.getElementById('startBtn').classList.remove('hidden');
        document.getElementById('cashoutBtn').classList.add('hidden');
        document.getElementById('newGameBtn').classList.add('hidden');
        document.getElementById('gameControls').style.opacity = '1';
        document.getElementById('gameControls').style.pointerEvents = 'auto';
    }

    // Initialize on page load
    initGrid();
</script>
{% endblock %}
