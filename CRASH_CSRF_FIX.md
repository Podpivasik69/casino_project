# üîß Crash - CSRF Token –ò—Å–ø—Ä–∞–≤–ª–µ–Ω!

## ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ –†–µ—à–µ–Ω–∞

**–û—à–∏–±–∫–∞**: "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ —Å—Ç–∞–≤–∫–∏"  
**–ü—Ä–∏—á–∏–Ω–∞ –≤ –ª–æ–≥–∞—Ö**: `Forbidden (CSRF token from the 'X-Csrftoken' HTTP header has incorrect length.)`

### –ß—Ç–æ –ë—ã–ª–æ –ù–µ –¢–∞–∫

–§—É–Ω–∫—Ü–∏—è `getCookie('csrftoken')` –∏–∑ base.html –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –æ—à–∏–±–∫–µ 403 Forbidden –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å —Å—Ç–∞–≤–∫—É.

### –ß—Ç–æ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

1. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è `getCSRFToken()`** –≤ crash.html:
   - –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –∏–∑ cookie
   - –ï—Å–ª–∏ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç, –±–µ—Ä–µ—Ç –∏–∑ DOM —ç–ª–µ–º–µ–Ω—Ç–∞ `[name=csrfmiddlewaretoken]`
   - –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ —Ç–æ–∫–µ–Ω –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç –Ω–∞–π–¥–µ–Ω

2. **–î–æ–±–∞–≤–ª–µ–Ω `{% csrf_token %}`** –≤ –Ω–∞—á–∞–ª–æ —à–∞–±–ª–æ–Ω–∞:
   - Django –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç —Å–∫—Ä—ã—Ç—ã–π input —Å —Ç–æ–∫–µ–Ω–æ–º
   - –§—É–Ω–∫—Ü–∏—è `getCSRFToken()` –º–æ–∂–µ—Ç –µ–≥–æ –Ω–∞–π—Ç–∏

3. **–ó–∞–º–µ–Ω–µ–Ω—ã –≤—Å–µ –≤—ã–∑–æ–≤—ã**:
   - `getCookie('csrftoken')` ‚Üí `getCSRFToken()`
   - –í —Ñ—É–Ω–∫—Ü–∏–∏ `placeBet()`
   - –í —Ñ—É–Ω–∫—Ü–∏–∏ `cashout()`

---

## üß™ –ö–∞–∫ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### 1. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏ –°—Ç—Ä–∞–Ω–∏—Ü—É
```
Ctrl + F5 (–∂–µ—Å—Ç–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞)
```

### 2. –û—Ç–∫—Ä–æ–π –ö–æ–Ω—Å–æ–ª—å –ë—Ä–∞—É–∑–µ—Ä–∞
```
F12 ‚Üí Console
```

### 3. –ü—Ä–æ–≤–µ—Ä—å CSRF –¢–æ–∫–µ–Ω
–í–≤–µ–¥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏:
```javascript
console.log(getCSRFToken());
```

–î–æ–ª–∂–µ–Ω –≤—ã–≤–µ—Å—Ç–∏ –¥–ª–∏–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É (64 —Å–∏–º–≤–æ–ª–∞), –Ω–∞–ø—Ä–∏–º–µ—Ä:
```
"abc123def456..."
```

### 4. –ü–æ–ø—Ä–æ–±—É–π –†–∞–∑–º–µ—Å—Ç–∏—Ç—å –°—Ç–∞–≤–∫—É
1. –î–æ–∂–¥–∏—Å—å –Ω–∞—á–∞–ª–∞ —Ä–∞—É–Ω–¥–∞ (WAITING)
2. –í–≤–µ–¥–∏ —Å—É–º–º—É: 10 ‚ÇΩ
3. –ù–∞–∂–º–∏ "–ü–æ—Å—Ç–∞–≤–∏—Ç—å"
4. –î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: "–°—Ç–∞–≤–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∞!" (–∑–µ–ª–µ–Ω–æ–µ)

### 5. –ü—Ä–æ–≤–µ—Ä—å –õ–æ–≥–∏ –°–µ—Ä–≤–µ—Ä–∞
–í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –≥–¥–µ –∑–∞–ø—É—â–µ–Ω —Å–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
INFO ... "POST /api/games/crash/bet/ HTTP/1.1" 200 ...
```

**–ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å**:
```
WARNING ... Forbidden (CSRF token ...)
```

---

## üîç –û—Ç–ª–∞–¥–∫–∞

### –ï—Å–ª–∏ –í—Å–µ –ï—â–µ –û—à–∏–±–∫–∞

**1. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–µ–Ω:**
```
–ü–æ—Å–º–æ—Ç—Ä–∏ –≤ –ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–∞–ª–∞–Ω—Å –∏ –∫–Ω–æ–ø–∫–∞ "–í—ã—Ö–æ–¥"
```

**2. –ü—Ä–æ–≤–µ—Ä—å CSRF —Ç–æ–∫–µ–Ω –≤ –∫–æ–Ω—Å–æ–ª–∏:**
```javascript
// –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä–æ–∫—É –¥–ª–∏–Ω–æ–π 64 —Å–∏–º–≤–æ–ª–∞
console.log(getCSRFToken());

// –ü—Ä–æ–≤–µ—Ä—å cookie
console.log(document.cookie);
```

**3. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞:**
```javascript
console.log(typeof getCSRFToken);  // –î–æ–ª–∂–Ω–æ –±—ã—Ç—å "function"
```

**4. –ü—Ä–æ–≤–µ—Ä—å DOM —ç–ª–µ–º–µ–Ω—Ç:**
```javascript
console.log(document.querySelector('[name=csrfmiddlewaretoken]'));
// –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å <input> —ç–ª–µ–º–µ–Ω—Ç
```

**5. –û—á–∏—Å—Ç–∏ –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞:**
```
Ctrl + Shift + Delete ‚Üí –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à
```

**6. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä:**
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏ —Ç–µ–∫—É—â–∏–π —Å–µ—Ä–≤–µ—Ä (Ctrl+C)
.venv\Scripts\python.exe manage.py runserver 0.0.0.0:8000
```

---

## üìù –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –î–µ—Ç–∞–ª–∏

### –ù–æ–≤–∞—è –§—É–Ω–∫—Ü–∏—è getCSRFToken()

```javascript
function getCSRFToken() {
    // –ü–æ–ø—ã—Ç–∫–∞ 1: –ü–æ–ª—É—á–∏—Ç—å –∏–∑ cookie
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, 10) === 'csrftoken=') {
                cookieValue = decodeURIComponent(cookie.substring(10));
                break;
            }
        }
    }
    
    // –ü–æ–ø—ã—Ç–∫–∞ 2: –ü–æ–ª—É—á–∏—Ç—å –∏–∑ DOM
    if (!cookieValue) {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            cookieValue = csrfInput.value;
        }
    }
    
    return cookieValue;
}
```

### Django CSRF Token

```django
{% csrf_token %}
```

–°–æ–∑–¥–∞–µ—Ç —Å–∫—Ä—ã—Ç—ã–π input:
```html
<input type="hidden" name="csrfmiddlewaretoken" value="abc123...">
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π –°–ø–∏—Å–æ–∫

–ü–µ—Ä–µ–¥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º —É–±–µ–¥–∏—Å—å:
- [x] –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω
- [x] –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞ (Ctrl+F5)
- [x] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–µ–Ω
- [x] –ë–∞–ª–∞–Ω—Å > 0
- [x] –†–∞—É–Ω–¥ –≤ —Å—Ç–∞—Ç—É—Å–µ WAITING
- [x] –ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–æ–∫
- [x] CSRF —Ç–æ–∫–µ–Ω –æ–ø—Ä–µ–¥–µ–ª–µ–Ω (–ø—Ä–æ–≤–µ—Ä—å –≤ –∫–æ–Ω—Å–æ–ª–∏)

---

## üéÆ –ì–æ—Ç–æ–≤–æ –∫ –ò–≥—Ä–µ!

–¢–µ–ø–µ—Ä—å —Å—Ç–∞–≤–∫–∏ –¥–æ–ª–∂–Ω—ã —Ä–∞–∑–º–µ—â–∞—Ç—å—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫!

**–û—Ç–∫—Ä—ã–≤–∞–π –∏ –∏–≥—Ä–∞–π:**
http://localhost:8000/crash/

**–õ–æ–≥–∏–Ω –¥–ª—è —Ç–µ—Å—Ç–∞:**
- Username: `crash_api_test`
- Password: `test123`

---

–£–¥–∞—á–∏! üöÄüí∞
